<%- include('../../partials/header', { title: (post && post.title) ? post.title : 'Post Not Found' }) %>

<main class="container mt-4">

  <% if (!post) { %>
    <!-- ‚ùå Post Not Found Message -->
    <div class="alert alert-danger text-center mt-5">
      <h3>Post Not Found</h3>
      <p>The post you are looking for might have been removed or doesn‚Äôt exist.</p>
      <a href="/posts" class="btn btn-primary mt-3">‚Üê Back to all posts</a>
    </div>

  <% } else { %>
    <article class="mb-4 post-view">

      <!-- üì∞ Post Title -->
      <h2 class="mb-2"><%= post.title %></h2>
      <p class="text-muted">
        <% if (post.author && post.author.name) { %>
          By <strong><%= post.author.name %></strong>
        <% } else { %>
          By <strong>Anonymous</strong>
        <% } %>
        | <%= new Date(post.createdAt).toLocaleString() %>
      </p>

      <!-- üñºÔ∏è Images Section -->
      <% if (post.images && post.images.length > 0) { %>
        <div class="post-images mb-3 text-center">
          <% post.images.forEach(img => { %>
            <img 
              src="<%= img %>" 
              alt="Post Image" 
              class="img-fluid rounded mb-3"
              style="max-height: 400px;"
            >
          <% }) %>
        </div>
      <% } %>

      <!-- üìù Post Content -->
      <div class="post-content mb-4">
        <p><%= post.content %></p>
      </div>

      <!-- ‚ù§Ô∏è Like Button -->
      <div class="mb-4">
        <button
          class="btn <%= user && post.likes && post.likes.includes(user._id) ? 'btn-success' : 'btn-outline-primary' %>"
          id="likeBtn"
          data-postid="<%= post._id %>"
        >
          <%= user && post.likes && post.likes.includes(user._id) ? '‚ù§Ô∏è Liked' : 'üëç Like' %>
          (<span id="likeCount"><%= post.likes ? post.likes.length : 0 %></span>)
        </button>
      </div>

      <hr>

      <!-- üí¨ Comments Section -->
      <section id="commentsSection" class="mt-4">
        <h4 class="mb-3">Comments (<%= post.comments ? post.comments.length : 0 %>)</h4>

        <% if (post.comments && post.comments.length > 0) { %>
          <% post.comments.forEach(comment => { %>
            <div class="comment-item mb-3 p-3 border rounded bg-light">
              <p class="mb-1">
                <strong><%= comment.author?.name || 'Anonymous' %></strong>
              </p>
              <p class="mb-0"><%= comment.content %></p>
              <small class="text-muted d-block mb-2">
                <%= new Date(comment.createdAt).toLocaleString() %>
              </small>

              <!-- üóëÔ∏è Delete Button (only for comment owner or admin) -->
              <% 
                const loggedUserId = user && (user._id || user.id) ? (user._id || user.id).toString() : null;
                const commentAuthorId = comment?.author?._id ? comment.author._id.toString() : null;
                const isOwner = loggedUserId && commentAuthorId && loggedUserId === commentAuthorId;
                const isAdmin = user && user.role === 'admin';
              %>

              <% if (isOwner || isAdmin) { %>
                <form 
                  action="/posts/<%= post._id %>/comments/<%= comment._id %>?_method=DELETE" 
                  method="POST" 
                  class="d-inline"
                  onsubmit="return confirm('Are you sure you want to delete your comment?');"
                >
                  <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Delete</button>
                </form>
              <% } %>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-muted">No comments yet. Be the first to comment!</p>
        <% } %>
      </section>

      <!-- ‚úçÔ∏è Comment Form -->
      <% if (user) { %>
        <form action="/posts/<%= post._id %>/comments" method="POST" class="mt-3">
          <div class="mb-3">
            <label for="content" class="form-label">Write your comment</label>
            <textarea id="content" name="content" class="form-control" rows="3" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Comment</button>
        </form>
      <% } else { %>
        <p class="mt-3">Please <a href="/login">login</a> to comment.</p>
      <% } %>

    </article>

    <a href="/posts" class="btn btn-secondary mt-4">‚Üê Back to all posts</a>
  <% } %>
</main>

<!-- ‚úÖ Like Button Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const likeBtn = document.getElementById("likeBtn");
  const likeCount = document.getElementById("likeCount");

  if (!likeBtn) return;

  likeBtn.addEventListener("click", async () => {
    const postId = likeBtn.dataset.postid;
    const url = `/posts/${postId}/like`;

    likeBtn.disabled = true;
    likeBtn.innerHTML = "‚ù§Ô∏è Updating...";

    try {
      const response = await fetch(url, { method: "POST" });
      const data = await response.json();

      if (response.status === 401) {
        alert("Please sign in to like posts.");
        window.location.href = "/login";
        return;
      }

      if (data.success) {
        const count = data.likesCount ?? 0;
        likeCount.textContent = count;

        if (data.liked) {
          likeBtn.innerHTML = `‚ù§Ô∏è Liked (${count})`;
          likeBtn.classList.add("btn-success");
          likeBtn.classList.remove("btn-outline-primary");
        } else {
          likeBtn.innerHTML = `üëç Like (${count})`;
          likeBtn.classList.remove("btn-success");
          likeBtn.classList.add("btn-outline-primary");
        }
      } else {
        alert("Failed to update like status.");
      }
    } catch (err) {
      console.error("Error liking post:", err);
      alert("Something went wrong!");
    } finally {
      likeBtn.disabled = false;
    }
  });
});
</script>

<%- include('../../partials/footer') %>
