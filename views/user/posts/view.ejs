<%- include('../../partials/header', { title: (post && post.title) ? post.title : 'Post Not Found' }) %>

<style>
/* ===== BACKGROUND & STYLES ===== */
body {
  background-image: url("/img/StockCake-Mountain_reading_escape_1762572141.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  font-family: "Poppins", sans-serif;
  color: #f9f9f9;
}
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(2px);
  z-index: -1;
}
main.container {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 2.5rem;
  margin-top: 3rem;
  color: #fff;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
.comment-item {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.1);
  color: #f9f9f9;
  padding: 0.75rem;
  border-radius: 10px;
  margin-bottom: 0.5rem;
}
.comment-item strong {
  color: #FFD89C;
}
.comment-input {
  background: rgba(255,255,255,0.1);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
}
.comment-input:focus {
  background: rgba(255,255,255,0.2);
  border-color: #FFD89C;
  box-shadow: none;
}
</style>

<main class="container">

  <% if (!post) { %>
    <div class="alert alert-danger text-center mt-5">
      <h3>Post Not Found</h3>
      <p>The post you are looking for might have been removed or doesn‚Äôt exist.</p>
      <a href="/posts" class="btn btn-primary mt-3">‚Üê Back to all posts</a>
    </div>
  <% } else { %>
    <article class="mb-4 post-view">
      <h2 class="mb-2"><%= post.title %></h2>
      <p class="text-muted">
        By <strong><%= post.author?.name || 'Anonymous' %></strong> |
        <%= new Date(post.createdAt).toLocaleString() %>
      </p>

      <% if (post.images?.length) { %>
        <div class="post-images mb-3 text-center">
          <% post.images.forEach(img => { %>
            <img src="<%= img %>" alt="Post Image" class="img-fluid rounded mb-3" style="max-height: 400px;">
          <% }) %>
        </div>
      <% } %>

      <div class="post-content mb-4">
        <p><%= post.content %></p>
      </div>

      <div class="mb-4">
        <button
          class="btn <%= user && post.likes?.includes(user._id) ? 'btn-success' : 'btn-outline-primary' %>"
          id="likeBtn"
          data-postid="<%= post._id %>"
        >
          <%= user && post.likes?.includes(user._id) ? '‚ù§Ô∏è Liked' : 'üëç Like' %>
          (<span id="likeCount"><%= post.likes ? post.likes.length : 0 %></span>)
        </button>
      </div>

      <hr>

      <!-- Comments Section -->
      <section id="commentsSection" class="mt-4">
        <h4 class="mb-3 text-warning">üí¨ Comments (<span id="commentCount"><%= post.comments?.length || 0 %></span>)</h4>

        <div class="comment-list mb-3">
          <% if (post.comments?.length) { %>
            <% post.comments.forEach(comment => { 
                 const loggedUserId = user && (user._id || user.id)?.toString();
                 const commentAuthorId = comment.author?._id?.toString() || comment.author?.toString();
                 const canDelete = loggedUserId && commentAuthorId && (loggedUserId === commentAuthorId || (user && user.role === 'admin'));
            %>
              <div class="comment-item" data-commentid="<%= comment._id %>">
                <p><strong><%= comment.author?.name || 'Anonymous' %></strong></p>
                <p><%= comment.content %></p>
                <small class="text-light"><%= new Date(comment.createdAt).toLocaleString() %></small>

                <% if (canDelete) { %>
                  <button class="comment-delete btn btn-sm btn-danger mt-1">üóëÔ∏è Delete</button>
                <% } %>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-light">No comments yet. Be the first to comment!</p>
          <% } %>
        </div>

        <% if (user) { %>
          <div class="comment-section">
            <textarea class="comment-input form-control mb-2" placeholder="Write your comment..." rows="3"></textarea>
            <button class="comment-btn btn btn-primary" data-postid="<%= post._id %>">Comment</button>
          </div>
        <% } else { %>
          <p class="mt-3">Please <a href="/login">login</a> to comment.</p>
        <% } %>
      </section>

      <a href="/posts" class="btn btn-secondary mt-4">‚Üê Back to all posts</a>
    </article>
  <% } %>
</main>

<%- include('../../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // üí¨ AJAX Add Comment
  document.querySelectorAll('.comment-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      const section = e.target.closest('.comment-section');
      const input = section.querySelector('.comment-input');
      const content = input.value.trim();
      const postId = e.target.dataset.postid;

      if (!content) return alert("Please write a comment first!");

      try {
        const response = await fetch(`/posts/${postId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        if (response.status === 401) return window.location.href = "/login";

        const data = await response.json();
        if (data.success) {
          const list = document.querySelector('.comment-list');
          const newComment = document.createElement('div');
          newComment.classList.add('comment-item');
          newComment.dataset.commentid = data.comment._id;
          newComment.innerHTML = `
            <p><strong>${data.comment.author?.name || 'You'}</strong></p>
            <p>${data.comment.content}</p>
            <small class="text-light">${new Date(data.comment.createdAt).toLocaleString()}</small>
          `;
          list.appendChild(newComment);

          input.value = '';
          const count = document.getElementById('commentCount');
          count.textContent = parseInt(count.textContent) + 1;
        } else {
          alert(data.message || "Failed to post comment.");
        }
      } catch (err) {
        console.error("Comment error:", err);
        alert("Something went wrong while posting comment.");
      }
    });
  });

  // üí¨ AJAX Delete Comment
  document.querySelector('.comment-list')?.addEventListener('click', async e => {
    if (e.target.classList.contains('comment-delete')) {
      const commentDiv = e.target.closest('.comment-item');
      const commentId = commentDiv.dataset.commentid;
      const postId = "<%= post._id %>";

      if (!confirm("Are you sure you want to delete this comment?")) return;

      try {
        const res = await fetch(`/posts/${postId}/comments/${commentId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (res.ok && data.success) {
          commentDiv.remove();
          const count = document.getElementById('commentCount');
          count.textContent = parseInt(count.textContent) - 1;
        } else {
          alert(data.message || "Failed to delete comment.");
        }
      } catch (err) {
        console.error("Delete comment error:", err);
        alert("Something went wrong while deleting comment.");
      }
    }
  });

  // ‚ù§Ô∏è AJAX Like Button
  const likeBtn = document.getElementById("likeBtn");
  if (likeBtn) {
    likeBtn.addEventListener("click", async () => {
      const postId = likeBtn.dataset.postid;
      try {
        const res = await fetch(`/posts/${postId}/like`, { method: "POST" });
        const data = await res.json();
        if (res.ok && data.success) {
          const likeCount = document.getElementById("likeCount");
          likeCount.textContent = data.likesCount;
          if (data.liked) {
            likeBtn.classList.add("btn-success");
            likeBtn.classList.remove("btn-outline-primary");
            likeBtn.textContent = `‚ù§Ô∏è Liked (${data.likesCount})`;
          } else {
            likeBtn.classList.add("btn-outline-primary");
            likeBtn.classList.remove("btn-success");
            likeBtn.textContent = `üëç Like (${data.likesCount})`;
          }
        } else if (res.status === 401) {
          window.location.href = "/login";
        }
      } catch (err) {
        console.error("Like error:", err);
      }
    });
  }

});
</script>
