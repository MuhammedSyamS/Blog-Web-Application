<%- include('../partials/header', { title: 'All Posts', user }) %>

<main class="container my-5" style="max-width: 1000px;">

  <!-- Page Header -->
  <div class="text-center mb-5">
    <h1 class="fw-bold display-4" style="font-family: 'Poppins', sans-serif; color: #e0e0e0; text-shadow: 0 2px 8px rgba(0,0,0,0.6); letter-spacing: 1px;">
      From Our Writers
    </h1>
    <p style="color: black; font-size: 1.2rem; font-family: 'Inter', sans-serif; letter-spacing: 1px; text-shadow: 0 1px 4px rgba(0,0,0,0.5);">
      Explore the latest posts from our amazing community
    </p>
  </div>

  <!-- User Greeting + Create Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-semibold" style="color: #f5c542; font-family: 'Poppins', sans-serif; text-shadow: 0 1px 6px rgba(0,0,0,0.5);">
      Welcome, <%= user ? user.name : 'Guest' %>
    </h4>

    <% if (user) { %>
      <a href="/posts/new" class="btn px-4 fw-semibold shadow-sm"
         style="background: linear-gradient(135deg, #f5c542, #ffb703); color: #222; border: none; font-weight: 600;">
        <i class="bi bi-plus-circle me-1"></i> Create New Post
      </a>
    <% } %>
  </div>

  <!-- Posts Feed -->
  <% if (posts && posts.length > 0) { %>
    <% posts.forEach(post => { %>
      <div class="card mb-5 border-0 shadow-lg mx-auto" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border-radius: 15px; color: #fff; width: 100%; max-width: 900px;">
        
        <!-- Post Image -->
        <% if (post.images && post.images.length > 0) { %>
          <img src="<%= post.images[0] %>" alt="Post Image" style="width: 100%; max-height: 500px; object-fit: cover; border-top-left-radius: 15px; border-top-right-radius: 15px;">
        <% } else { %>
          <div class="d-flex align-items-center justify-content-center text-light" style="height: 500px; background: rgba(255,255,255,0.05); border-top-left-radius: 15px; border-top-right-radius: 15px;">
            <i class="bi bi-image" style="font-size: 3rem;"></i>
          </div>
        <% } %>

        <div class="card-body">

          <!-- Post Title & Author -->
          <h5 class="card-title fw-bold mb-1" style="color:#fff;"><%= post.title %></h5>
          <small class="mb-3" style="color:#ddd;">
            By <%= post.author ? post.author.name : 'Unknown' %> ‚Ä¢ <%= new Date(post.createdAt).toLocaleDateString() %>
          </small>

          <!-- Post Content -->
          <p class="card-text" style="color:#f5f5f5;">
            <%= post.content || 'No content available.' %>
          </p>

          <!-- Like & Read More -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <a href="/posts/<%= post._id %>" class="btn btn-sm btn-outline-primary">Read More ‚Üí</a>
            <button class="btn btn-sm like-btn <%= (user && post.likes && post.likes.some(like => like && like.toString() === (user._id || user.id))) ? 'btn-danger' : 'btn-outline-danger' %>" data-postid="<%= post._id %>">
              ‚ù§Ô∏è <span class="like-count"><%= post.likes ? post.likes.length : 0 %></span>
            </button>
          </div>

          <!-- Comment Section -->
          <div class="mt-3 p-3 rounded-3 shadow-sm comment-section" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
            <h6 class="fw-semibold mb-2" style="color:#ffc107;">üí¨ Comments</h6>

            <div class="comment-list">
              <% if (post.comments && post.comments.length > 0) { %>
                <% post.comments.forEach(comment => { %>
                  <p class="mb-1" style="color:#f1f1f1;">
                    <strong><%= comment.author && comment.author.name ? comment.author.name : 'Anonymous' %>:</strong>
                    <%= comment.text || comment.content || comment.comment || '' %>
                  </p>
                <% }) %>
              <% } else { %>
                <p class="text-muted small">No comments yet.</p>
              <% } %>
            </div>

            <% if (user) { %>
              <div class="d-flex align-items-center mt-2">
                <input type="text" class="form-control form-control-sm me-2 comment-input" placeholder="Write a comment..." style="background: rgba(255,255,255,0.1); border: none; color: #fff;">
                <button class="btn btn-sm btn-warning fw-semibold text-dark px-3 comment-btn" data-postid="<%= post._id %>">Post</button>
              </div>
            <% } else { %>
              <p class="text-muted small mt-2">Login to comment.</p>
            <% } %>
          </div>

          <!-- Edit/Delete -->
          <% if (user && post.author && post.author._id && (post.author._id.toString() === (user._id || user.id))) { %>
            <div class="card-footer bg-transparent border-0 d-flex justify-content-end mt-2" style="backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1);">
              <a href="/posts/edit/<%= post._id %>" class="btn btn-sm btn-warning me-2">
                <i class="bi bi-pencil-square"></i> Edit
              </a>
              <form action="/posts/delete/<%= post._id %>" method="POST" class="d-inline">
                <button type="submit" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </form>
            </div>
          <% } %>

        </div>
      </div>
    <% }) %>
  <% } else { %>
    <div class="text-center p-5 rounded shadow-sm mt-5" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); color:#fff;">
      <h4 class="mb-3">No posts yet üìù</h4>
      <% if (user) { %>
        <p>Be the first to <a href="/posts/new" class="fw-semibold text-decoration-none text-primary">create one!</a></p>
      <% } else { %>
        <p><a href="/login" class="fw-semibold text-decoration-none text-primary">Login</a> to create your first post!</p>
      <% } %>
    </div>
  <% } %>

</main>

<script>
// Like & comment JS remains the same
</script>

<%- include('../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // üí¨ Comment Button
  document.querySelectorAll('.comment-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      const section = e.target.closest('.comment-section');
      const input = section.querySelector('.comment-input');
      const content = input.value.trim();  // ‚úÖ correct key name
      const postId = e.target.dataset.postid;

      if (!content) return alert("Please write a comment first!");

      try {
        const response = await fetch(`/posts/${postId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content }) // ‚úÖ send 'content'
        });

        if (response.status === 401) {
          return window.location.href = "/login";
        }

        const data = await response.json();
        if (data.success) {
          const list = section.querySelector('.comment-list');
          const newComment = document.createElement('p');
          newComment.classList.add('mb-1');
          newComment.style.color = '#f1f1f1';
          newComment.innerHTML = `<strong>${data.comment.author || 'You'}:</strong> ${data.comment.content}`;
          list.appendChild(newComment);

          input.value = '';
        } else {
          alert(data.message || "Failed to post comment.");
        }
      } catch (err) {
        console.error("Comment error:", err);
        alert("Something went wrong while posting comment.");
      }
    });
  });

});
</script>
