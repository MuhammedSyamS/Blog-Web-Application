<%- include('../partials/header', { title: 'All Posts',user }) %>




<main class="container mt-4">

  <!-- ğŸ“° Page Header -->
  <div class="text-center mb-5">
    <h1 class="fw-bold">ğŸ“° All Posts</h1>
    <p class="text-muted">Latest posts from our community</p>
  </div>

  <!-- ğŸ‘¤ User Greeting + Create Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Welcome, <%= user ? user.name : 'Guest' %></h4>

    <% if (user) { %>
      <a href="/posts/new" class="btn btn-success">+ Create New Post</a>
    <% } %>
  </div>

  <!-- ğŸ§¾ Posts List -->
  <% if (posts && posts.length > 0) { %>
    <% posts.forEach(post => { %>
      <div class="card mb-5 shadow-sm border-0">
        <div class="card-body">

          <!-- ğŸ·ï¸ Post Title & Author -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h4 class="card-title mb-1"><%= post.title %></h4>
              <small class="text-muted">
                By <%= post.author ? post.author.name : 'Unknown' %> â€¢ 
                <%= new Date(post.createdAt).toLocaleDateString() %>
              </small>
            </div>

            <!-- âœï¸ Edit/Delete (for post owner) -->
            <% if (user && post.author && post.author._id && (post.author._id.toString() === (user._id || user.id))) { %>
              <div>
                <a href="/posts/edit/<%= post._id %>" class="btn btn-sm btn-warning me-1">
                  âœï¸ Edit
                </a>
                <form action="/posts/delete/<%= post._id %>" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ï¸ Delete</button>
                </form>
              </div>
            <% } %>
          </div>

          <!-- ğŸ–¼ï¸ Images -->
          <% if (post.images && post.images.length > 0) { %>
            <div class="image-gallery d-flex overflow-auto gap-2 mb-3 p-2 border rounded" style="scrollbar-width: thin;">
              <% post.images.forEach(image => { %>
                <img 
                  src="<%= image %>" 
                  alt="Post Image"
                  style="width: 100%; max-width: 320px; height: 200px; object-fit: cover; border-radius: 10px;">
              <% }); %>
            </div>
          <% } %>

          <!-- ğŸ“ Content -->
          <p class="card-text text-secondary">
            <%= post.content ? post.content.substring(0, 200) + (post.content.length > 200 ? '...' : '') : 'No content available.' %>
          </p>

          <!-- â¤ï¸ Like & Read More -->
          <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
            <a href="/posts/<%= post._id %>" class="btn btn-sm btn-primary">
              Read More â†’
            </a>

            <button
              class="btn btn-sm like-btn
              <%= (user && post.likes && post.likes.some(like => like && like.toString() === (user._id || user.id))) 
                  ? 'btn-danger' 
                  : 'btn-outline-danger' %>"
              data-postid="<%= post._id %>"
            >
              â¤ï¸ <span class="like-count"><%= post.likes ? post.likes.length : 0 %></span>
            </button>
          </div>

          <!-- ğŸ’¬ Comments Section -->
          <div class="border-top pt-3 mt-3">
            <h6 class="fw-bold mb-3">ğŸ’¬ Comments (<%= post.comments ? post.comments.length : 0 %>)</h6>

            <% if (user) { %>
              <form action="/posts/<%= post._id %>/comments" method="POST" class="mb-3">
                <div class="input-group">
                  <input 
                    type="text" 
                    name="content" 
                    class="form-control" 
                    placeholder="Write a comment..." 
                    required
                  >
                  <button type="submit" class="btn btn-outline-primary">Post</button>
                </div>
              </form>
            <% } else { %>
              <p class="text-muted small">Please <a href="/login">log in</a> to comment.</p>
            <% } %>

            <% if (post.comments && post.comments.length > 0) { %>
              <ul class="list-group">
                <% post.comments.forEach(comment => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= comment.author ? comment.author.name : 'Anonymous' %></strong>
                      <p class="mb-1"><%= comment.content %></p>
                      <small class="text-muted"><%= new Date(comment.createdAt).toLocaleString() %></small>
                    </div>

                    <!-- ğŸ—‘ï¸ Delete Button for Comment Owner or Admin -->
                    <% if (
                      user && comment.author &&
                      (comment.author._id.toString() === (user._id || user.id) || user.role === 'admin')
                    ) { %>
                      <form 
                        action="/posts/<%= post._id %>/comments/<%= comment._id %>?_method=DELETE"
                        method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this comment?');"
                      >
                        <button type="submit" class="btn btn-sm btn-danger ms-2">ğŸ—‘ï¸</button>
                      </form>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <p class="text-muted">No comments yet.</p>
            <% } %>
          </div>

        </div>
      </div>
    <% }) %>
  <% } else { %>
    <!-- âŒ No Posts -->
    <div class="text-center p-5 bg-light rounded shadow-sm">
      <h4 class="mb-3">No posts yet ğŸ“</h4>
      <% if (user) { %>
        <p>Be the first to <a href="/posts/new" class="text-decoration-none">create one!</a></p>
      <% } else { %>
        <p><a href="/login" class="text-decoration-none">Login</a> to create your first post!</p>
      <% } %>
    </div>
  <% } %>
</main>

<!-- â¤ï¸ Like Button Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const postId = button.dataset.postid;
      const url = `/posts/${postId}/like`;
      button.disabled = true;

      try {
        const response = await fetch(url, { method: 'POST' });
        if (response.status === 401) {
          window.location.href = "/login";
          return;
        }

        const data = await response.json();
        if (data.success) {
          const likeCount = button.querySelector('.like-count');
          if (likeCount) likeCount.textContent = data.likesCount;
          button.classList.toggle('btn-danger', data.liked);
          button.classList.toggle('btn-outline-danger', !data.liked);
        }
      } catch (err) {
        console.error("Like error:", err);
      } finally {
        button.disabled = false;
      }
    });
  });
});
</script>

<%- include('../partials/footer') %>
